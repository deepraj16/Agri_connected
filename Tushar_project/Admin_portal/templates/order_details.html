<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - Admin Panel</title>
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸŒ¾ Admin Panel</h2>
            </div>
            <ul class="sidebar-menu">
                <li>
                    <a href="/dashboard">
                        <span class="icon">ğŸ“Š</span>
                        Dashboard
                    </a>
                </li>
                <li class="active">
                    <a href="/orders">
                        <span class="icon">ğŸ“¦</span>
                        Orders
                    </a>
                </li>
                <li>
                    <a href="/logout">
                        <span class="icon">ğŸšª</span>
                        Logout
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <header class="topbar">
                <h1>Order Details</h1>
                <div class="user-info">
                    <a href="/orders" class="btn btn-sm">â† Back to Orders</a>
                </div>
            </header>

            <div class="content-area">
                <div id="orderDetails">
                    <p class="loading">Loading order details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('statusModal')">&times;</span>
            <h2>Update Order Status</h2>
            <form id="statusForm">
                <div class="form-group">
                    <label for="orderStatus">Order Status</label>
                    <select id="orderStatus" class="form-control" required>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="sendEmailStatus" checked style="width: 18px; height: 18px;">
                        <span>ğŸ“§ Send email notification to customer</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Update Status</button>
            </form>
        </div>
    </div>

    <!-- Update Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('paymentModal')">&times;</span>
            <h2>Update Payment Status</h2>
            <form id="paymentForm">
                <div class="form-group">
                    <label for="paymentStatus">Payment Status</label>
                    <select id="paymentStatus" class="form-control" required>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="sendEmailPayment" checked style="width: 18px; height: 18px;">
                        <span>ğŸ“§ Send payment confirmation email</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-success btn-block">Update Payment</button>
            </form>
        </div>
    </div>

    <!-- Email Actions Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('emailModal')">&times;</span>
            <h2>ğŸ“§ Send Email Notifications</h2>
            <div class="email-actions">
                <button onclick="sendEmail('customer_confirmation')" class="btn btn-primary btn-block">
                    ğŸ“¨ Send Order Confirmation to Customer
                </button>
                <button onclick="sendEmail('farmer_notification')" class="btn btn-success btn-block">
                    ğŸŒ¾ Send Order Notification to Farmer
                </button>
                <button onclick="sendEmail('status_update')" class="btn btn-info btn-block">
                    ğŸ“¢ Send Status Update to Customer
                </button>
                <button onclick="sendEmail('payment_confirmation')" class="btn btn-warning btn-block">
                    ğŸ’° Send Payment Confirmation
                </button>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 5px; border-left: 4px solid #f59e0b;">
                <p style="margin: 0; font-size: 13px; color: #92400e;">
                    <strong>Note:</strong> Emails will only be sent if the recipient has a valid email address in the database.
                </p>
            </div>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
        const orderId = {{ order_id }};
        let currentOrder = null;

        async function loadOrderDetails() {
            try {
                const response = await fetch(`/api/admin/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                currentOrder = await response.json();
                console.log('Order loaded:', currentOrder);
                displayOrderDetails(currentOrder);
            } catch (error) {
                console.error('Error loading order:', error);
                document.getElementById('orderDetails').innerHTML = 
                    `<div class="card">
                        <div class="card-body">
                            <p class="text-error">âŒ Failed to load order details.</p>
                            <p class="text-muted">${error.message}</p>
                            <a href="/orders" class="btn btn-primary">Back to Orders</a>
                        </div>
                    </div>`;
            }
        }

        function displayOrderDetails(order) {
            const html = `
                <div class="order-details-grid">
                    <!-- Order Information Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2>ğŸ“¦ Order #${order.id}</h2>
                            <span class="badge badge-${getStatusColor(order.order_status)}">${order.order_status.toUpperCase()}</span>
                        </div>
                        <div class="card-body">
                            <div class="detail-row">
                                <span class="label">Payment ID:</span>
                                <span class="value"><strong>${order.payment_id || 'N/A'}</strong></span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Product Name:</span>
                                <span class="value">${order.product_name}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Product ID:</span>
                                <span class="value">#${order.product_id}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Quantity:</span>
                                <span class="value"><strong>${order.quantity}</strong></span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Total Amount:</span>
                                <span class="value" style="font-size: 20px; color: #10b981;"><strong>â‚¹${order.total_amount.toFixed(2)}</strong></span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Payment Status:</span>
                                <span class="badge badge-${getPaymentColor(order.payment_status)}">${order.payment_status.toUpperCase()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Order Date:</span>
                                <span class="value">${formatDate(order.created_at)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2>ğŸ‘¤ Customer Information</h2>
                        </div>
                        <div class="card-body">
                            <div class="detail-row">
                                <span class="label">Customer ID:</span>
                                <span class="value">#${order.customer_id}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Name:</span>
                                <span class="value"><strong>${order.customer_name}</strong></span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Username:</span>
                                <span class="value">${order.customer_username}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Phone:</span>
                                <span class="value">ğŸ“± ${order.customer_phone}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Email:</span>
                                <span class="value">âœ‰ï¸ ${order.customer_email}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Farmer Information Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2>ğŸŒ¾ Farmer Information</h2>
                        </div>
                        <div class="card-body">
                            <div class="detail-row">
                                <span class="label">Farmer ID:</span>
                                <span class="value">#${order.farmer_id}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Name:</span>
                                <span class="value"><strong>${order.farmer_name}</strong></span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Username:</span>
                                <span class="value">${order.farmer_username}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Phone:</span>
                                <span class="value">ğŸ“± ${order.farmer_phone}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Email:</span>
                                <span class="value">âœ‰ï¸ ${order.farmer_email}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Address:</span>
                                <span class="value">ğŸ“ ${order.farmer_address}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2>âš™ï¸ Admin Actions</h2>
                        </div>
                        <div class="card-body">
                            <div class="actions-grid">
                                <button onclick="openModal('statusModal')" class="btn btn-primary btn-block">
                                    ğŸ“¦ Update Order Status
                                </button>
                                <button onclick="openModal('paymentModal')" class="btn btn-success btn-block">
                                    ğŸ’³ Update Payment Status
                                </button>
                                <button onclick="openModal('emailModal')" class="btn btn-info btn-block">
                                    ğŸ“§ Send Email Notifications
                                </button>
                                <button onclick="deleteOrder()" class="btn btn-danger btn-block">
                                    ğŸ—‘ï¸ Delete Order
                                </button>
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 5px;">
                                <p style="margin: 0; font-size: 13px; color: #666;">
                                    <strong>Note:</strong> Updating status will immediately change the order state. 
                                    Deleting an order cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('orderDetails').innerHTML = html;
        }

        function openModal(modalId) {
            if (modalId === 'statusModal') {
                document.getElementById('orderStatus').value = currentOrder.order_status;
            } else if (modalId === 'paymentModal') {
                document.getElementById('paymentStatus').value = currentOrder.payment_status;
            }
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Update Order Status Form Handler
        document.getElementById('statusForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const status = document.getElementById('orderStatus').value;
            const sendEmail = document.getElementById('sendEmailStatus').checked;
            
            try {
                const formData = new FormData();
                formData.append('order_status', status);
                formData.append('send_email', sendEmail);
                
                const response = await fetch(`/api/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = 'âœ… Order status updated successfully!';
                    if (result.email_sent) {
                        message += ' Email notification sent.';
                    }
                    showSuccess(message);
                    closeModal('statusModal');
                    setTimeout(() => loadOrderDetails(), 500);
                } else {
                    showError('âŒ Failed to update status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showError('âŒ Failed to update status: ' + error.message);
            }
        });

        // Update Payment Status Form Handler
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const status = document.getElementById('paymentStatus').value;
            const sendEmail = document.getElementById('sendEmailPayment').checked;
            
            try {
                const formData = new FormData();
                formData.append('payment_status', status);
                formData.append('send_email', sendEmail);
                
                const response = await fetch(`/api/admin/orders/${orderId}/payment`, {
                    method: 'PUT',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = 'âœ… Payment status updated successfully!';
                    if (result.email_sent) {
                        message += ' Confirmation email sent.';
                    }
                    showSuccess(message);
                    closeModal('paymentModal');
                    setTimeout(() => loadOrderDetails(), 500);
                } else {
                    showError('âŒ Failed to update payment status');
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                showError('âŒ Failed to update payment status: ' + error.message);
            }
        });

        // Send Email Function
        async function sendEmail(emailType) {
            try {
                const formData = new FormData();
                formData.append('email_type', emailType);
                
                const response = await fetch(`/api/admin/orders/${orderId}/send-email`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.email_sent) {
                    showSuccess('âœ… ' + result.message);
                } else {
                    showError('âš ï¸ ' + result.message);
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showError('âŒ Failed to send email: ' + error.message);
            }
        }

        // Delete Order Function
        async function deleteOrder() {
            if (!confirm('âš ï¸ Are you sure you want to delete this order?\n\nThis action cannot be undone!')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('âœ… Order deleted successfully!');
                    setTimeout(() => {
                        window.location.href = '/orders';
                    }, 1500);
                } else {
                    showError('âŒ Failed to delete order');
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                showError('âŒ Failed to delete order: ' + error.message);
            }
        }

        // Load order details on page load
        loadOrderDetails();

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
