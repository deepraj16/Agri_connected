<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - AgriMarket</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .back-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 25px; border-radius: 20px; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block; font-weight: 600; }
        .back-btn:hover { background: white; color: #667eea; transform: translateY(-2px); }
        .header h1 { color: white; font-size: 2.5em; }

        /* Tabs */
        .tabs { display: flex; gap: 15px; margin-bottom: 30px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 15px; }
        .tab { flex: 1; padding: 15px; background: transparent; color: white; border: 2px solid transparent; border-radius: 10px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; text-align: center; }
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active { background: white; color: #667eea; border-color: white; }

        /* Orders Container */
        .orders-container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); min-height: 400px; }
        .loading { text-align: center; padding: 60px; color: #999; font-size: 1.3em; }
        .empty { text-align: center; padding: 60px; color: #999; }
        .empty-icon { font-size: 4em; margin-bottom: 20px; }

        /* Order Card */
        .order-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid #667eea; transition: all 0.3s; }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .order-id { font-size: 1em; color: #666; font-weight: 600; }
        .order-date { color: #999; font-size: 0.9em; }
        .order-status { padding: 8px 20px; border-radius: 20px; font-size: 0.9em; font-weight: 600; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-delivered { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        /* Order Details */
        .order-details { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .order-item { }
        .item-name { font-size: 1.3em; color: #333; font-weight: 600; margin-bottom: 5px; }
        .item-meta { color: #666; font-size: 0.95em; }
        .order-quantity { text-align: center; }
        .order-price { text-align: right; }
        .price-label { color: #999; font-size: 0.9em; display: block; margin-bottom: 5px; }
        .price-value { font-size: 1.5em; color: #667eea; font-weight: bold; }

        /* Provider Info */
        .provider-info { background: white; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .provider-info h4 { color: #667eea; margin-bottom: 10px; font-size: 1em; }
        .provider-info p { color: #666; font-size: 0.95em; margin: 5px 0; }

        /* Service Booking Card */
        .booking-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid #11998e; transition: all 0.3s; }
        .booking-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .booking-date-badge { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 8px 15px; border-radius: 10px; display: inline-block; margin-top: 10px; font-size: 0.9em; }

        /* Filter Section */
        .filter-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .filter-section select { padding: 10px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; cursor: pointer; }
        .order-count { color: #666; font-size: 1.1em; }

        /* Responsive */
        @media (max-width: 768px) {
            .order-details { grid-template-columns: 1fr; gap: 10px; }
            .order-quantity, .order-price { text-align: left; }
            .header h1 { font-size: 1.8em; }
            .tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <a href="marketplace.html" class="back-btn">‚Üê Back to Marketplace</a>
            <h1>My Orders</h1>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('products')">üåæ Product Orders</div>
            <div class="tab" onclick="switchTab('services')">üöú Service Bookings</div>
        </div>

        <!-- Product Orders Container -->
        <div id="productsContainer" class="orders-container">
            <div class="filter-section">
                <div class="order-count" id="productCount">Loading...</div>
                <select id="productFilter" onchange="filterOrders('products')">
                    <option value="all">All Orders</option>
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                    <option value="delivered">Delivered</option>
                </select>
            </div>
            <div id="productsLoading" class="loading">Loading your orders...</div>
            <div id="productsEmpty" class="empty" style="display: none;">
                <div class="empty-icon">üì¶</div>
                <h2>No Orders Yet</h2>
                <p>You haven't placed any product orders yet.</p>
            </div>
            <div id="productsGrid"></div>
        </div>

        <!-- Service Bookings Container -->
        <div id="servicesContainer" class="orders-container" style="display: none;">
            <div class="filter-section">
                <div class="order-count" id="serviceCount">Loading...</div>
                <select id="serviceFilter" onchange="filterOrders('services')">
                    <option value="all">All Bookings</option>
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div id="servicesLoading" class="loading">Loading your bookings...</div>
            <div id="servicesEmpty" class="empty" style="display: none;">
                <div class="empty-icon">üöú</div>
                <h2>No Bookings Yet</h2>
                <p>You haven't booked any services yet.</p>
            </div>
            <div id="servicesGrid"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentUser = null;
        let allProductOrders = [];
        let allServiceBookings = [];
        let currentTab = 'products';

        window.onload = function() {
            const userData = sessionStorage.getItem('userData');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(userData);
            loadProductOrders();
            loadServiceBookings();
        };

        function switchTab(tab) {
            currentTab = tab;
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'products') {
                document.getElementById('productsContainer').style.display = 'block';
                document.getElementById('servicesContainer').style.display = 'none';
            } else {
                document.getElementById('productsContainer').style.display = 'none';
                document.getElementById('servicesContainer').style.display = 'block';
            }
        }

        async function loadProductOrders() {
            const loading = document.getElementById('productsLoading');
            const empty = document.getElementById('productsEmpty');
            const grid = document.getElementById('productsGrid');
            const count = document.getElementById('productCount');

            try {
                const response = await fetch(`${API_URL}/api/orders/customer/${currentUser.customer_id}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch orders');
                }

                allProductOrders = await response.json();

                loading.style.display = 'none';

                if (allProductOrders.length === 0) {
                    empty.style.display = 'block';
                    count.textContent = '0 orders';
                } else {
                    count.textContent = `${allProductOrders.length} order${allProductOrders.length > 1 ? 's' : ''}`;
                    displayProductOrders(allProductOrders);
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                loading.textContent = 'Error loading orders. Please try again.';
            }
        }

        async function loadServiceBookings() {
            const loading = document.getElementById('servicesLoading');
            const empty = document.getElementById('servicesEmpty');
            const grid = document.getElementById('servicesGrid');
            const count = document.getElementById('serviceCount');

            try {
                const response = await fetch(`${API_URL}/api/service-bookings/customer/${currentUser.customer_id}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch bookings');
                }

                allServiceBookings = await response.json();

                loading.style.display = 'none';

                if (allServiceBookings.length === 0) {
                    empty.style.display = 'block';
                    count.textContent = '0 bookings';
                } else {
                    count.textContent = `${allServiceBookings.length} booking${allServiceBookings.length > 1 ? 's' : ''}`;
                    displayServiceBookings(allServiceBookings);
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                loading.textContent = 'Error loading bookings. Please try again.';
            }
        }

        function displayProductOrders(orders) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">Order #${order.id}</div>
                            <div class="order-date">${formatDate(order.order_date || order.created_at)}</div>
                        </div>
                        <div class="order-status status-${order.payment_status || 'pending'}">
                            ${(order.payment_status || 'pending').toUpperCase()}
                        </div>
                    </div>
                    <div class="order-details">
                        <div class="order-item">
                            <div class="item-name">${order.product_name || 'Product'}</div>
                            <div class="item-meta">üì¶ ${order.quantity} units</div>
                        </div>
                        <div class="order-quantity">
                            <span class="price-label">Quantity</span>
                            <div style="font-size: 1.5em; font-weight: bold; color: #333;">${order.quantity}</div>
                        </div>
                        <div class="order-price">
                            <span class="price-label">Total Price</span>
                            <div class="price-value">‚Çπ${order.total_price}</div>
                        </div>
                    </div>
                    <div class="provider-info">
                        <h4>üë®‚Äçüåæ Farmer Details</h4>
                        <p><strong>Name:</strong> ${order.farmer_name || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${order.farmer_phone || 'N/A'}</p>
                    </div>
                </div>
            `).join('');
        }

        function displayServiceBookings(bookings) {
            const grid = document.getElementById('servicesGrid');
            grid.innerHTML = bookings.map(booking => `
                <div class="booking-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">Booking #${booking.id}</div>
                            <div class="order-date">${formatDate(booking.created_at)}</div>
                        </div>
                        <div class="order-status status-${booking.payment_status || 'pending'}">
                            ${(booking.payment_status || 'pending').toUpperCase()}
                        </div>
                    </div>
                    <div class="order-details">
                        <div class="order-item">
                            <div class="item-name">${booking.service_name || 'Service'}</div>
                            <div class="item-meta">‚è∞ ${booking.hours} hour${booking.hours > 1 ? 's' : ''}</div>
                            <div class="booking-date-badge">üìÖ ${formatDate(booking.booking_date)}</div>
                        </div>
                        <div class="order-quantity">
                            <span class="price-label">Duration</span>
                            <div style="font-size: 1.5em; font-weight: bold; color: #333;">${booking.hours}h</div>
                        </div>
                        <div class="order-price">
                            <span class="price-label">Total Price</span>
                            <div class="price-value" style="color: #11998e;">‚Çπ${booking.total_price}</div>
                        </div>
                    </div>
                    <div class="provider-info">
                        <h4>üë§ Service Provider</h4>
                        <p><strong>Name:</strong> ${booking.provider_name || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${booking.provider_phone || 'N/A'}</p>
                        <p><strong>Service Type:</strong> ${booking.service_type || 'N/A'}</p>
                    </div>
                </div>
            `).join('');
        }

        function filterOrders(type) {
            const filter = document.getElementById(type === 'products' ? 'productFilter' : 'serviceFilter').value;

            if (type === 'products') {
                const filtered = filter === 'all' 
                    ? allProductOrders 
                    : allProductOrders.filter(order => (order.payment_status || 'pending') === filter);
                displayProductOrders(filtered);
                document.getElementById('productCount').textContent = `${filtered.length} order${filtered.length !== 1 ? 's' : ''}`;
            } else {
                const filtered = filter === 'all' 
                    ? allServiceBookings 
                    : allServiceBookings.filter(booking => (booking.payment_status || 'pending') === filter);
                displayServiceBookings(filtered);
                document.getElementById('serviceCount').textContent = `${filtered.length} booking${filtered.length !== 1 ? 's' : ''}`;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('en-IN', options);
        }
    </script>
</body>
</html>